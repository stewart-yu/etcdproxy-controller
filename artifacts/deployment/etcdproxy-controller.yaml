---
apiVersion: v1
kind: Namespace
metadata:
  name: kube-apiserver-storage
spec:
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: etcdproxy-sa
  namespace: kube-apiserver-storage
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: etcdproxy-crd-clusterrole
rules:
- apiGroups: ["etcd.xmudrii.com"]
  resources: ["etcdstorages"]
  verbs: ["get", "watch", "list"]
- apiGroups: ["etcd.xmudrii.com"]
  resources: ["etcdstorages/status"]
  verbs: ["get", "watch", "list", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: etcdproxy-role
  namespace: kube-apiserver-storage
rules:
- apiGroups: ["apps"]
  resources: ["replicasets"]
  verbs: ["get", "watch", "list", "create", "update", "patch", "delete"]
- apiGroups: [""]
  resources: ["services"]
  verbs: ["get", "watch", "list", "create", "update", "patch", "delete"]
- apiGroups: [""]
  resources: ["secrets", "configmaps"]
  verbs: ["get", "watch", "list", "create", "update", "patch", "delete"]
- apiGroups: [""]
  resources: ["secrets"]
  resourceNames: ["etcd-coreserving-cert"]
  verbs: ["get", "watch", "list"]
- apiGroups: [""]
  resources: ["configmaps"]
  resourceNames: ["etcd-coreserving-ca"]
  verbs: ["get", "watch", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: etcdproxy-crd-clusterrolebinding
subjects:
- kind: ServiceAccount
  name: etcdproxy-sa # Name is case sensitive
  namespace: kube-apiserver-storage
roleRef:
  kind: ClusterRole #this must be Role or ClusterRole
  name: etcdproxy-crd-clusterrole # this must match the name of the Role or ClusterRole you wish to bind to
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: etcdproxy-rolebinding
  namespace: kube-apiserver-storage
subjects:
- kind: ServiceAccount
  name: etcdproxy-sa # Name is case sensitive
  namespace: kube-apiserver-storage
roleRef:
  kind: Role #this must be Role or ClusterRole
  name: etcdproxy-role # this must match the name of the Role or ClusterRole you wish to bind to
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: etcdstorages.etcd.xmudrii.com
spec:
  group: etcd.xmudrii.com
  version: v1alpha1
  names:
    kind: EtcdStorage
    plural: etcdstorages
  scope: Cluster
  validation:
    openAPIV3Schema:
      properties:
        metadata:
          properties:
            name:
              type: string
              maxLength: 59 # because of service name, explained above.
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: etcdproxy-controller-deployment
  namespace: kube-apiserver-storage
  labels:
    controller: etcdproxy
spec:
  replicas: 1
  selector:
    matchLabels:
      controller: etcdproxy
  template:
    metadata:
      labels:
        controller: etcdproxy
    spec:
      serviceAccountName: etcdproxy-sa
      containers:
      - name: etcdproxy-controller
        image: xmudrii/etcdproxy-controller:latest
        command:
          - /etcdproxy-controller
          - "-etcd-core-url=https://etcd-svc-1.etcd.svc:2379"
        imagePullPolicy: Always
